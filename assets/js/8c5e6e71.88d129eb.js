"use strict";(self.webpackChunkictf_docs=self.webpackChunkictf_docs||[]).push([[3893],{5046:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>p,frontMatter:()=>i,metadata:()=>o,toc:()=>u});var r=t(4848),s=t(8453);const i={},a=void 0,o={id:"challenges/stop-the-spammer/solution.py",title:"solution.py",description:"",source:"@site/docs/challenges/stop-the-spammer/solution.py.mdx",sourceDirName:"challenges/stop-the-spammer",slug:"/challenges/stop-the-spammer/solution.py",permalink:"/ictf-docs/challenges/stop-the-spammer/solution.py",draft:!1,unlisted:!1,editUrl:"https://github.com/ucsb-seclab/ictf-docs/tree/main/docs/challenges/stop-the-spammer/solution.py.mdx",tags:[],version:"current",frontMatter:{},sidebar:"challenges",previous:{title:"Stop the spammer!",permalink:"/ictf-docs/challenges/stop-the-spammer/"},next:{title:"supermart",permalink:"/ictf-docs/challenges/supermart/"}},c={},u=[];function l(e){const n={code:"code",pre:"pre",...(0,s.R)(),...e.components};return(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"import imagehash\r\nfrom PIL import Image\r\nfrom tqdm import tqdm\r\nimport numpy as np\r\nfrom collections import Counter\r\nimport os\r\n\r\n# read the data files\r\nquery_images = np.load(os.path.join('src','model_queries.npy'))\r\n\r\nfp = open(os.path.join('src', 'user_query_indices.txt'), 'r')\r\nuser_query_indices = {}\r\n\r\n# each line in the file is a user id (first line: user-id:0, second line, user-id:1...)\r\nfor ii, l in enumerate(fp.readlines()):\r\n    items = l.split(',')\r\n    user_query_indices[ii] = np.asarray([int(i) for i in items])\r\n\r\n\r\n# take the perceptual hash of each item to find near duplicates\r\nall_hashes = []\r\nfor im in tqdm(query_images):\r\n    h = hash(im.tobytes())\r\n    all_hashes.append(str(h))\r\nall_hashes = np.asarray(all_hashes)\r\n\r\n# find the users that issued multiple similar images, suspicious\r\nall_hashes_ctr = Counter(all_hashes)\r\nduplicate_image_hashes = [h for h,cnt in all_hashes_ctr.items() if cnt > 1]\r\n\r\nuser_duplicate_counts = {}\r\n\r\nfor imh in duplicate_image_hashes:\r\n    duplicate_image_indices = np.where(all_hashes == imh)[0]\r\n    for uid in user_query_indices:\r\n        if len(np.intersect1d(duplicate_image_indices, user_query_indices[uid])) > 0:\r\n            if uid not in user_duplicate_counts:\r\n                user_duplicate_counts[uid] = 0\r\n            user_duplicate_counts[uid] += 1\r\n\r\nuser_duplicate_counts_ctr = Counter(user_duplicate_counts)\r\n\r\n# find the suspicious users that sent near duplicates\r\nattackers = [uid for uid, ctr in user_duplicate_counts_ctr.most_common() if ctr > 1]\r\n\r\n# construct the flag\r\nbad_users_string = f','.join([str(i) for i in np.sort(attackers)])\r\nflag = f'ictf{{{bad_users_string}}}'\r\n\r\nfp = open('flag_sol.txt', 'w')\r\nfp.write(flag)\r\nfp.close()\r\nprint(f\"flag {flag}\")\n"})})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var r=t(6540);const s={},i=r.createContext(s);function a(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);