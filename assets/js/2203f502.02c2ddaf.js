"use strict";(self.webpackChunkictf_docs=self.webpackChunkictf_docs||[]).push([[2081],{2114:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>u,contentTitle:()=>o,default:()=>l,frontMatter:()=>i,metadata:()=>a,toc:()=>p});var s=r(4848),n=r(8453);const i={},o=void 0,a={id:"writeups/stop-the-model-thief/solution.py",title:"solution.py",description:"",source:"@site/docs/writeups/stop-the-model-thief/solution.py.md",sourceDirName:"writeups/stop-the-model-thief",slug:"/writeups/stop-the-model-thief/solution.py",permalink:"/ictf-docs/writeups/stop-the-model-thief/solution.py",draft:!1,unlisted:!1,editUrl:"https://github.com/ucsb-seclab/ictf-docs/tree/main/docs/writeups/stop-the-model-thief/solution.py.md",tags:[],version:"current",frontMatter:{},sidebar:"writeups",previous:{title:"Stop the model thief!",permalink:"/ictf-docs/writeups/stop-the-model-thief/"},next:{title:"Stop the spammer!",permalink:"/ictf-docs/writeups/stop-the-spammer/"}},u={},p=[];function c(e){const t={code:"code",pre:"pre",...(0,n.R)(),...e.components};return(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-python",children:"import imagehash\r\nfrom PIL import Image\r\nfrom tqdm import tqdm\r\nimport numpy as np\r\nfrom collections import Counter\r\nimport os\r\n\r\n# read the data files\r\nquery_images = np.load(os.path.join('src','model_queries.npy'))\r\n\r\nfp = open(os.path.join('src', 'user_query_indices.txt'), 'r')\r\nuser_query_indices = {}\r\n\r\n# each line in the file is a user id (first line: user-id:0, second line, user-id:1...)\r\nfor ii, l in enumerate(fp.readlines()):\r\n    items = l.split(',')\r\n    user_query_indices[ii] = np.asarray([int(i) for i in items])\r\n\r\n\r\n# take the perceptual hash of each item to find near duplicates\r\nall_hashes = []\r\nfor im in tqdm(query_images):\r\n    img = Image.fromarray(im.astype(np.uint8))\r\n    h = imagehash.phash(img)\r\n    all_hashes.append(str(h))\r\nall_hashes = np.asarray(all_hashes)\r\n\r\n# find the users that issued multiple similar images, suspicious\r\nsuspicious = {}\r\nfor imh, cnt in Counter(all_hashes).most_common():\r\n    if cnt == 1:\r\n        break\r\n\r\n    image_indices = np.where(all_hashes == imh)[0]\r\n    for uid in user_query_indices:\r\n        if len(np.intersect1d(image_indices, user_query_indices[uid])):\r\n            if uid not in suspicious:\r\n                suspicious[uid] = [imh]\r\n            else:\r\n                suspicious[uid].append(imh)\r\n\r\n# find the suspicious users with the most near duplciates\r\nattackers = sorted(list(suspicious.keys()), key=lambda k: len(suspicious[k]), reverse=True)\r\n\r\n# we give as a hint that there are 20 accounts\r\nattackers = attackers[:20]\r\n\r\n# construct the flag\r\nbad_users_string = f','.join([str(i) for i in np.sort(attackers)])\r\nflag = f'ictf{{{bad_users_string}}}'\r\n\r\nfp = open('flag_sol.txt', 'w')\r\nfp.write(flag)\r\nfp.close()\n"})})}function l(e={}){const{wrapper:t}={...(0,n.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,t,r)=>{r.d(t,{R:()=>o,x:()=>a});var s=r(6540);const n={},i=s.createContext(n);function o(e){const t=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:o(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);